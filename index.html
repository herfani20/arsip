<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsip Digital Abadi</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
        .box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; text-align: center; }
        .upload-area { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 15px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-main { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; }
        .file-item { background: #fff; padding: 15px; border: 1px solid #eee; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-dl { background: #34a853; color: white; padding: 8px 12px; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .btn-del { background: #ea4335; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }
        #status { text-align: center; font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

<div class="box">
    <h2>üìÅ Arsip Digital Saya</h2>
    <div class="upload-area">
        <input type="file" id="pilih-file">
        <input type="text" id="nama-file" placeholder="Beri nama file...">
        <button class="btn-main" onclick="uploadKeCloud()">SIMPAN PERMANEN</button>
        <p id="status"></p>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Daftar File:</h3>
        <button onclick="muatDaftarFile()" style="width:auto; padding:5px 10px; font-size:11px;">üîÑ Segarkan</button>
    </div>
    <div id="daftar-file-container"></div>
</div>

<script>
    const CLOUD_NAME = "doa3owxki"; 
    const UPLOAD_PRESET = "arsipsaya";
    
    // Objek untuk menyimpan token hapus sementara
    let deleteTokens = JSON.parse(localStorage.getItem('del_tokens') || '{}');

    async function uploadKeCloud() {
        const fileInput = document.getElementById('pilih-file');
        const namaInput = document.getElementById('nama-file');
        const status = document.getElementById('status');

        if (!fileInput.files[0] || !namaInput.value) return alert("Lengkapi data!");

        status.innerText = "‚è≥ Menyimpan...";
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('public_id', namaInput.value); 
        formData.append('tags', 'arsip_pribadi'); 

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                status.innerText = "‚úÖ Tersimpan!";
                // Simpan token hapus ke browser
                deleteTokens[data.public_id] = data.delete_token;
                localStorage.setItem('del_tokens', JSON.stringify(deleteTokens));
                
                setTimeout(muatDaftarFile, 2000);
            }
        } catch (err) { status.innerText = "‚ùå Gagal!"; }
    }

    async function muatDaftarFile() {
        const container = document.getElementById('daftar-file-container');
        try {
            const res = await fetch(`https://res.cloudinary.com/${CLOUD_NAME}/image/list/arsip_pribadi.json?cb=${Date.now()}`);
            const data = await res.json();
            container.innerHTML = ""; 

            data.resources.forEach(file => {
                const downloadUrl = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${file.public_id}.${file.format}`;
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span style="font-weight:bold;">${file.public_id}</span>
                    <div>
                        <a href="${downloadUrl}" class="btn-dl" target="_blank">LIHAT</a>
                        <button class="btn-del" onclick="hapusFileLangsung('${file.public_id}')">HAPUS</button>
                    </div>`;
                container.appendChild(item);
            });
        } catch (err) { container.innerHTML = "Gagal memuat."; }
    }

    async function hapusFileLangsung(publicId) {
        const token = deleteTokens[publicId];
        if (!token) return alert("Maaf, file ini hanya bisa dihapus lewat Dashboard Cloudinary demi keamanan.");
        
        if (confirm(`Hapus permanen "${publicId}"?`)) {
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/delete_by_token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                if (res.ok) {
                    alert("Berhasil dihapus!");
                    delete deleteTokens[publicId];
                    localStorage.setItem('del_tokens', JSON.stringify(deleteTokens));
                    muatDaftarFile();
                }
            } catch (err) { alert("Gagal menghapus."); }
        }
    }

    window.onload = muatDaftarFile;
</script>
</body>
</html>
